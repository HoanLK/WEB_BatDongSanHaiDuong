backend.controller("editProjectController",["$scope","$http","$window","$cookies","$routeParams","Services",function(n,t,i,r,u,f){function o(){n.id=u.id;n.changeImage=!1;f.CheckNull(n.id)?(n.page.title="Sửa Dự án",c(n.id)):(n.page.title="Thêm Dự án",h());l();f.GetCurrentAccount().then(function(t){n.project.UserId=t.data.Id})}function h(){n.project={Published:!0,Featured:!1,MucGia:"Liên hệ",TimeCreated:f.ToUTCDate(new Date),Views:0};n.image={};n.images=[]}function c(t){f.Get(e+"/"+t).then(function(t){n.project=angular.copy(t.data);f.Get(apiImageProject+"?request=ByProject&&value="+n.project.Id).then(function(t){n.images=angular.copy(t.data)},function(){toastr.error("Không lấy được hình ảnh")})},function(){toastr.error("Không tìm thấy Dự án");i.location.href="/Admin#!/project"})}function l(){f.Get(s+"?viewmodel=true&&type=select").then(function(t){n.categoryProjects=angular.copy(f.GenMultiLevel(t.data))},function(){toastr.error("Không lấy được Danh sách danh mục")})}function a(){var t=0;return angular.forEach(n.valid,function(n,i){if(!n){switch(i){case"Title":toastr.error("Nhập Tiêu đề");break;case"Alias":toastr.error("Nhập Alias")}t++}}),t===0?!0:!1}function v(){var t=0;return angular.forEach(n.validImage,function(n,i){if(!n){switch(i){case"Image":toastr.error("Chọn hình ảnh")}t++}}),t===0?!0:!1}var e,s;n.page={};n.projects=[];n.tempProjects=[];n.project={};n.selectedProjects=[];e="/API/ProjectAPI";n.categoryProjects=[];s="/API/CategoryProjectAPI";n.images=[];n.image={};n.changeImage=!1;apiImageProject="/API/ImageProjectAPI";n.valid={Title:!1,Alias:!1};n.validImage={Image:!1};n.statuses=[{text:"Xuất bản",value:!0},{text:"Không xuất bản",value:!1}];n.modifyImage=!1;n.titlePopupModifyImage="Thêm hình ảnh";n.popupModifyImage={maxWidth:600,height:"auto",contentTemplate:"templateModifyImage",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyImage",visible:"modifyImage"}};n.deleteImage=!1;n.titleDeleteImage="Bạn có chắc chắn muốn xóa?";n.popupDeleteImage={width:"auto",height:"auto",contentTemplate:"templateDeleteImage",showTitle:!1,bindingOptions:{visible:"deleteImage"}};o();n.Save=function(t){a()&&(f.CheckNull(n.id)?f.Edit(e,n.project.Id,n.project).then(function(){if(n.changeImage==!0)f.DeleteByRequest(apiImageProject,"ByProject",n.project.Id).then(function(r){r.data==1&&(angular.forEach(n.images,function(t,i){n.images[i].ProjectId=n.project.Id}),f.Create("/ImageProject/AddList",n.images).then(function(){toastr.success("Lưu thành công");switch(t){case"Edit":o();break;case"New":i.location.href="/Admin#!/project/edit";break;case"Exit":i.location.href="/Admin#!/project"}},function(){toastr.error("Lưu thất bại")}))},function(){});else{toastr.success("Lưu thành công");switch(t){case"Edit":o();break;case"New":i.location.href="/Admin#!/project/edit";break;case"Exit":i.location.href="/Admin#!/project"}}},function(){toastr.error("Lưu thất bại")}):f.Create(e,n.project).then(function(r){n.project=angular.copy(r.data);angular.forEach(n.images,function(t,i){n.images[i].ProjectId=n.project.Id});f.Create("/ImageProject/AddList",n.images).then(function(){toastr.success("Thêm thành công");switch(t){case"Edit":i.location.href="/Admin#!/project/edit/"+n.project.Id;break;case"New":o();break;case"Exit":i.location.href="/Admin#!/project"}},function(){toastr.error("Thêm thất bại")})},function(){toastr.error("Thêm thất bại")}))};n.Cancel=function(){i.location.href="/Admin#!/project"};n.AddImage=function(){n.modifyImage=!0;n.image={}};n.SaveImage=function(){v()&&(n.changeImage=!0,n.modifyImage=!1,angular.isDefined(n.image.index)?n.images[n.image.index]=angular.copy(n.image):n.images.push(n.image),n.image={})};n.CancelSaveImage=function(){n.modifyImage=!1;n.image={}};n.EditImage=function(t){n.modifyImage=!0;n.image=angular.copy(n.images[t]);n.image.index=angular.copy(t)};n.DeleteImage=function(t){n.deleteImage=!0;n.image=angular.copy(n.images[t]);n.image.index=angular.copy(t)};n.ConfirmDeleteImage=function(){n.changeImage=!0;n.deleteImage=!1;n.images.splice(n.image.index,1)};n.CancelDeleteImage=function(){n.deleteImage=!1};n.tab=1;n.SetTab=function(t){n.tab=t};n.IsSet=function(t){return n.tab===t};n.GenAlias=function(){n.valid.Title?n.project.Alias=f.GenAlias(n.project.Title):toastr.error("Vui lòng nhập Tiêu đề")};n.ChooseImage=function(){var t=new CKFinder;t.selectActionFunction=function(t){n.project.Image=t;n.$apply()};t.SelectFunction="ShowFileInfo";t.popup()};n.ChooseImageProject=function(){var t=new CKFinder;t.selectActionFunction=function(t){n.image.Image=t;n.$apply()};t.SelectFunction="ShowFileInfo";t.popup()};n.CheckNullTitle=function(){return f.CheckNull(n.project.Title)?(n.valid.Title=!0,!0):(n.valid.Title=!1,!1)};n.CheckNullAlias=function(){return f.CheckNull(n.project.Alias)?(n.valid.Alias=!0,!0):(n.valid.Alias=!1,!1)};n.CheckNullImage=function(){return f.CheckNull(n.image.Image)?(n.validImage.Image=!0,!0):(n.validImage.Image=!1,!1)}}]);